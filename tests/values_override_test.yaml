suite: test values overrides
templates:
  - deployment.yaml
  - service.yaml
  - cronjob.yaml
  - job.yaml
tests:
  - it: should override image with --set
    template: deployment.yaml
    set:
      mode: http
      image.repository: custom-app
      image.tag: custom-tag
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: custom-app:custom-tag

  - it: should override replica count with --set
    template: deployment.yaml
    set:
      mode: http
      replicaCount: 10
    asserts:
      - equal:
          path: spec.replicas
          value: 10

  - it: should change mode to worker
    template: deployment.yaml
    set:
      mode: worker
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.labels["app.kubernetes.io/mode"]
          value: worker

  - it: service should not exist in worker mode
    template: service.yaml
    set:
      mode: worker
    asserts:
      - hasDocuments:
          count: 0

  - it: should override service port
    template: service.yaml
    set:
      mode: http
      service.port: 8080
      service.targetPort: 3000
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 8080
      - equal:
          path: spec.ports[0].targetPort
          value: 3000

  - it: should override cronjob schedule
    template: cronjob.yaml
    set:
      mode: cron
      cronjob.schedule: "*/5 * * * *"
    asserts:
      - equal:
          path: spec.schedule
          value: "*/5 * * * *"

  - it: should override job parallelism
    template: job.yaml
    set:
      mode: job
      job.parallelism: 5
      job.completions: 10
    asserts:
      - equal:
          path: spec.parallelism
          value: 5
      - equal:
          path: spec.completions
          value: 10

  - it: should override with multiple environment variables
    template: deployment.yaml
    set:
      mode: http
      env:
        - name: VAR1
          value: value1
        - name: VAR2
          value: value2
        - name: VAR3
          value: value3
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VAR1
            value: value1
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VAR2
            value: value2
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: VAR3
            value: value3

  - it: should override resources
    template: deployment.yaml
    set:
      mode: http
      resources.requests.cpu: 250m
      resources.requests.memory: 256Mi
      resources.limits.cpu: 1000m
      resources.limits.memory: 1Gi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 250m
      - equal:
          path: spec.template.spec.containers[0].resources.requests.memory
          value: 256Mi
      - equal:
          path: spec.template.spec.containers[0].resources.limits.cpu
          value: 1000m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 1Gi

  - it: should enable probes with overrides
    template: deployment.yaml
    set:
      mode: http
      livenessProbe.enabled: true
      livenessProbe.httpGet.path: /healthz
      livenessProbe.initialDelaySeconds: 60
      readinessProbe.enabled: true
      readinessProbe.httpGet.path: /readyz
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /healthz
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.initialDelaySeconds
          value: 60
      - equal:
          path: spec.template.spec.containers[0].readinessProbe.httpGet.path
          value: /readyz

  - it: should override fullname
    template: deployment.yaml
    set:
      mode: http
      fullnameOverride: my-custom-name
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-name

  - it: should override nameOverride
    template: deployment.yaml
    set:
      mode: http
      nameOverride: custom
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: custom
