suite: test deployment
templates:
  - deployment.yaml
tests:
  - it: should create deployment in http mode
    set:
      mode: http
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-app
      - equal:
          path: spec.replicas
          value: 1

  - it: should create deployment in worker mode
    set:
      mode: worker
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-app

  - it: should not create deployment in cron mode
    set:
      mode: cron
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create deployment in job mode
    set:
      mode: job
    asserts:
      - hasDocuments:
          count: 0

  - it: should set correct replica count
    set:
      mode: http
      replicaCount: 5
    asserts:
      - equal:
          path: spec.replicas
          value: 5

  - it: should not set replicas when autoscaling is enabled
    set:
      mode: http
      autoscaling.enabled: true
    asserts:
      - isNull:
          path: spec.replicas

  - it: should use correct image
    set:
      mode: http
      image.repository: my-app
      image.tag: v1.2.3
    asserts:
      - equal:
          path: spec.template.spec.containers[0].image
          value: my-app:v1.2.3

  - it: should set custom command and args
    set:
      mode: http
      command: ["/bin/sh"]
      args: ["-c", "echo hello"]
    asserts:
      - equal:
          path: spec.template.spec.containers[0].command
          value: ["/bin/sh"]
      - equal:
          path: spec.template.spec.containers[0].args
          value: ["-c", "echo hello"]

  - it: should include port for http mode
    set:
      mode: http
      service.targetPort: 3000
    asserts:
      - contains:
          path: spec.template.spec.containers[0].ports
          content:
            name: http
            containerPort: 3000
            protocol: TCP

  - it: should not include port for worker mode
    set:
      mode: worker
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].ports

  - it: should set environment variables
    set:
      mode: http
      env:
        - name: TEST_VAR
          value: test-value
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: TEST_VAR
            value: test-value

  - it: should set envFrom
    set:
      mode: http
      envFrom:
        - secretRef:
            name: my-secret
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: my-secret

  - it: should set resources
    set:
      mode: http
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 512Mi
    asserts:
      - equal:
          path: spec.template.spec.containers[0].resources.requests.cpu
          value: 100m
      - equal:
          path: spec.template.spec.containers[0].resources.limits.memory
          value: 512Mi

  - it: should include liveness probe when enabled
    set:
      mode: http
      livenessProbe.enabled: true
      livenessProbe.httpGet.path: /health
      livenessProbe.httpGet.port: http
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].livenessProbe
      - equal:
          path: spec.template.spec.containers[0].livenessProbe.httpGet.path
          value: /health

  - it: should not include liveness probe when disabled
    set:
      mode: http
      livenessProbe.enabled: false
    asserts:
      - isNull:
          path: spec.template.spec.containers[0].livenessProbe

  - it: should include readiness probe when enabled
    set:
      mode: http
      readinessProbe.enabled: true
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].readinessProbe

  - it: should include startup probe when enabled
    set:
      mode: http
      startupProbe.enabled: true
    asserts:
      - isNotNull:
          path: spec.template.spec.containers[0].startupProbe

  - it: should set selector labels
    set:
      mode: http
    asserts:
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/name"]
          value: app
      - equal:
          path: spec.selector.matchLabels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should include mode label
    set:
      mode: http
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/mode"]
          value: http

  - it: should set service account name
    set:
      mode: http
      serviceAccount.create: true
    asserts:
      - equal:
          path: spec.template.spec.serviceAccountName
          value: RELEASE-NAME-app

  - it: should add volumes
    set:
      mode: http
      volumes:
        - name: test-volume
          emptyDir: {}
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: test-volume
            emptyDir: {}

  - it: should add volume mounts
    set:
      mode: http
      volumeMounts:
        - name: test-volume
          mountPath: /data
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: test-volume
            mountPath: /data

  - it: should add init containers
    set:
      mode: http
      initContainers:
        - name: init-test
          image: busybox
    asserts:
      - contains:
          path: spec.template.spec.initContainers
          content:
            name: init-test
            image: busybox

  - it: should add sidecars
    set:
      mode: http
      sidecars:
        - name: sidecar-test
          image: sidecar:latest
    asserts:
      - contains:
          path: spec.template.spec.containers
          content:
            name: sidecar-test
            image: sidecar:latest

  - it: should set node selector
    set:
      mode: http
      nodeSelector:
        environment: production
    asserts:
      - equal:
          path: spec.template.spec.nodeSelector.environment
          value: production

  - it: should set tolerations
    set:
      mode: http
      tolerations:
        - key: node-role
          operator: Equal
          value: worker
          effect: NoSchedule
    asserts:
      - contains:
          path: spec.template.spec.tolerations
          content:
            key: node-role
            operator: Equal
            value: worker
            effect: NoSchedule

  - it: should set affinity
    set:
      mode: http
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/hostname
                    operator: In
                    values: [node1]
    asserts:
      - isNotNull:
          path: spec.template.spec.affinity

  - it: should set pod annotations
    set:
      mode: http
      podAnnotations:
        prometheus.io/scrape: "true"
    asserts:
      - equal:
          path: spec.template.metadata.annotations["prometheus.io/scrape"]
          value: "true"

  - it: should set security contexts
    set:
      mode: http
      podSecurityContext:
        runAsUser: 1000
      securityContext:
        allowPrivilegeEscalation: false
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1000
      - equal:
          path: spec.template.spec.containers[0].securityContext.allowPrivilegeEscalation
          value: false
