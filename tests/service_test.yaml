suite: test service
templates:
  - service.yaml
tests:
  - it: should create service in http mode when enabled
    set:
      mode: http
      service.enabled: true
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-app

  - it: should not create service when disabled
    set:
      mode: http
      service.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create service in worker mode
    set:
      mode: worker
      service.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create service in cron mode
    set:
      mode: cron
      service.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should not create service in job mode
    set:
      mode: job
      service.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: should set service type to ClusterIP by default
    set:
      mode: http
    asserts:
      - equal:
          path: spec.type
          value: ClusterIP

  - it: should set service type to NodePort
    set:
      mode: http
      service.type: NodePort
    asserts:
      - equal:
          path: spec.type
          value: NodePort

  - it: should set service type to LoadBalancer
    set:
      mode: http
      service.type: LoadBalancer
    asserts:
      - equal:
          path: spec.type
          value: LoadBalancer

  - it: should set correct ports
    set:
      mode: http
      service.port: 80
      service.targetPort: 3000
    asserts:
      - equal:
          path: spec.ports[0].port
          value: 80
      - equal:
          path: spec.ports[0].targetPort
          value: 3000
      - equal:
          path: spec.ports[0].protocol
          value: TCP
      - equal:
          path: spec.ports[0].name
          value: http

  - it: should set nodePort when type is NodePort
    set:
      mode: http
      service.type: NodePort
      service.nodePort: 30080
    asserts:
      - equal:
          path: spec.ports[0].nodePort
          value: 30080

  - it: should not set nodePort when type is not NodePort
    set:
      mode: http
      service.type: ClusterIP
    asserts:
      - isNull:
          path: spec.ports[0].nodePort

  - it: should set selector labels
    set:
      mode: http
    asserts:
      - equal:
          path: spec.selector["app.kubernetes.io/name"]
          value: app
      - equal:
          path: spec.selector["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should set service annotations
    set:
      mode: http
      service.annotations:
        service.beta.kubernetes.io/aws-load-balancer-type: nlb
    asserts:
      - equal:
          path: metadata.annotations["service.beta.kubernetes.io/aws-load-balancer-type"]
          value: nlb

  - it: should include standard labels
    set:
      mode: http
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
      - equal:
          path: metadata.labels["app.kubernetes.io/mode"]
          value: http
