suite: test configmap and secret
templates:
  - configmap.yaml
  - secret.yaml
tests:
  - it: should create configmap when enabled
    template: configmap.yaml
    set:
      configMap.enabled: true
      configMap.data:
        app.config: "test: value"
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-universal-app
      - equal:
          path: data["app.config"]
          value: "test: value"

  - it: should not create configmap when disabled
    template: configmap.yaml
    set:
      configMap.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom configmap name
    template: configmap.yaml
    set:
      configMap.enabled: true
      configMap.name: my-custom-config
      configMap.data:
        test: value
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-config

  - it: should include standard labels in configmap
    template: configmap.yaml
    set:
      configMap.enabled: true
      configMap.data:
        test: value
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: universal-app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME

  - it: should create secret when enabled
    template: secret.yaml
    set:
      secret.enabled: true
      secret.data:
        password: cGFzc3dvcmQ=
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-universal-app
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.password
          value: cGFzc3dvcmQ=

  - it: should not create secret when disabled
    template: secret.yaml
    set:
      secret.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should use custom secret name
    template: secret.yaml
    set:
      secret.enabled: true
      secret.name: my-custom-secret
      secret.stringData:
        username: admin
    asserts:
      - equal:
          path: metadata.name
          value: my-custom-secret

  - it: should support stringData in secret
    template: secret.yaml
    set:
      secret.enabled: true
      secret.stringData:
        username: admin
        password: secretpassword
    asserts:
      - equal:
          path: stringData.username
          value: admin
      - equal:
          path: stringData.password
          value: secretpassword

  - it: should support both data and stringData in secret
    template: secret.yaml
    set:
      secret.enabled: true
      secret.data:
        encoded: YmFzZTY0
      secret.stringData:
        plain: text
    asserts:
      - equal:
          path: data.encoded
          value: YmFzZTY0
      - equal:
          path: stringData.plain
          value: text

  - it: should include standard labels in secret
    template: secret.yaml
    set:
      secret.enabled: true
      secret.stringData:
        test: value
    asserts:
      - equal:
          path: metadata.labels["app.kubernetes.io/name"]
          value: universal-app
      - equal:
          path: metadata.labels["app.kubernetes.io/instance"]
          value: RELEASE-NAME
