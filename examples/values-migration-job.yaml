# Database Migration Job Example
# Use: helm install migration ./helm-chart -f examples/values-migration-job.yaml

mode: job

image:
  repository: my-app-migrations
  tag: "v1.5.2"
  pullPolicy: IfNotPresent

# Job configuration
job:
  restartPolicy: Never  # Don't restart on failure
  backoffLimit: 3
  completions: 1
  parallelism: 1
  activeDeadlineSeconds: 600  # 10 minutes timeout
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour

# Migration command
command: ["npm"]
args: ["run", "migrate:up"]

env:
  - name: MIGRATION_DIR
    value: /app/migrations
  - name: MIGRATION_TABLE
    value: schema_migrations
  - name: LOG_LEVEL
    value: debug

# Database credentials from secret
envFrom:
  - secretRef:
      name: database-credentials

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Init container to check database connectivity
initContainers:
  - name: wait-for-db
    image: postgres:14-alpine
    command:
      - sh
      - -c
      - |
        until pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do
          echo "Waiting for database..."
          sleep 2
        done
        echo "Database is ready!"
    envFrom:
      - secretRef:
          name: database-credentials
